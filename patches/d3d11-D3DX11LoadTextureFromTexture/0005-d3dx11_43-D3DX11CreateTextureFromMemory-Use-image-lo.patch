From 1c0e362d9ca6ff68666b77a6ebe70a73b686ee65 Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Tue, 1 Aug 2023 11:13:30 +1000
Subject: [PATCH 5/6] d3dx11_43: D3DX11CreateTextureFromMemory - Use image load
 data if possible

---
 dlls/d3dx11_43/texture.c | 25 ++++++++++++++++++-------
 1 file changed, 18 insertions(+), 7 deletions(-)

diff --git a/dlls/d3dx11_43/texture.c b/dlls/d3dx11_43/texture.c
index d633e5ce3e3..76b6615d74d 100644
--- a/dlls/d3dx11_43/texture.c
+++ b/dlls/d3dx11_43/texture.c
@@ -451,17 +451,28 @@ HRESULT WINAPI D3DX11CreateTextureFromMemory(ID3D11Device *device, const void *s
 
     if (!src_data || !src_data_size || !texture)
         return E_FAIL;
-    if (load_info)
-        FIXME("load_info is ignored.\n");
     if (pump)
         FIXME("Thread pump is not supported yet.\n");
 
-    if (FAILED(D3DX11GetImageInfoFromMemory(src_data, src_data_size, NULL, &img_info, NULL)))
-        return E_FAIL;
-    if (img_info.MiscFlags & D3D11_RESOURCE_MISC_TEXTURECUBE)
+    if (load_info)
     {
-        FIXME("Cube map is not supported.\n");
-        return E_FAIL;
+        img_info.Width = load_info->Width;
+        img_info.Height = load_info->Height;
+        img_info.Depth  = load_info->Depth;
+        img_info.ArraySize = 1;
+        img_info.MipLevels = load_info->MipLevels;
+        img_info.MiscFlags = load_info->MiscFlags;
+        img_info.Format = load_info->Format;
+    }
+    else
+    {
+        if (FAILED(D3DX11GetImageInfoFromMemory(src_data, src_data_size, NULL, &img_info, NULL)))
+            return E_FAIL;
+        if (img_info.MiscFlags & D3D11_RESOURCE_MISC_TEXTURECUBE)
+        {
+            FIXME("Cube map is not supported.\n");
+            return E_FAIL;
+        }
     }
 
     if (FAILED(hr = WICCreateImagingFactory_Proxy(WINCODEC_SDK_VERSION, &factory)))
-- 
2.40.1

