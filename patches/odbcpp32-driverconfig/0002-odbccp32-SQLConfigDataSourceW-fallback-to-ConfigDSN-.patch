From 57dbae2824c826564804264e17746a413a186a08 Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Fri, 16 Aug 2024 10:11:55 +1000
Subject: [PATCH 2/2] odbccp32: SQLConfigDataSourceW fallback to ConfigDSN when
 ConfigDSNW cannot be found

---
 dlls/odbccp32/odbccp32.c | 48 +++++++++++++++++++++++++++++++++++++++-
 1 file changed, 47 insertions(+), 1 deletion(-)

diff --git a/dlls/odbccp32/odbccp32.c b/dlls/odbccp32/odbccp32.c
index e96742265ce..d3b5169357f 100644
--- a/dlls/odbccp32/odbccp32.c
+++ b/dlls/odbccp32/odbccp32.c
@@ -688,6 +688,38 @@ static LPWSTR SQLInstall_strdup_multi(LPCSTR str)
     return ret;
 }
 
+static LPSTR SQLInstall_strdup_multiWtoA(LPCWSTR str)
+{
+    LPCWSTR p;
+    LPSTR ret = NULL;
+    DWORD len;
+
+    if (!str)
+        return ret;
+
+    for (p = str; *p; p += lstrlenW(p) + 1)
+        ;
+
+    len = WideCharToMultiByte(CP_ACP, 0, str,   p - str, NULL, 0, NULL, NULL );
+    ret = malloc((len + 1));
+    WideCharToMultiByte(CP_ACP, 0, str, p - str, ret, len, NULL, NULL );
+    ret[len] = 0;
+
+    return ret;
+}
+
+static inline char *strdupWtoA( const WCHAR *str )
+{
+    char *ret = NULL;
+    if (str)
+    {
+        DWORD len = WideCharToMultiByte( CP_ACP, 0, str, -1, NULL, 0, NULL, NULL );
+        if ((ret = malloc( len )))
+            WideCharToMultiByte( CP_ACP, 0, str, -1, ret, len, NULL, NULL );
+    }
+    return ret;
+}
+
 static LPWSTR SQLInstall_strdup(LPCSTR str)
 {
     DWORD len;
@@ -952,7 +984,21 @@ BOOL WINAPI SQLConfigDataSourceW(HWND hwnd, WORD request, LPCWSTR driver, LPCWST
     if(pConfigDSNW)
         ret = pConfigDSNW(hwnd, mapped_request, driver, attributes);
     else
-        ERR("Failed to find ConfigDSNW\n");
+    {
+        pConfigDSN = (void*)GetProcAddress(mod, "ConfigDSN");
+        if (pConfigDSN)
+        {
+            LPSTR attr = SQLInstall_strdup_multiWtoA(attributes);
+            char *driverA = strdupWtoA(driver);
+            TRACE("Calling ConfigDSN\n");
+
+            ret = pConfigDSN(hwnd, mapped_request, driverA, attr);
+            free(attr);
+            free(driverA);
+        }
+        else
+            ERR("Failed to find ConfigDSN/W\n");
+    }
 
     config_mode = config_mode_prev;
 
-- 
2.43.0

