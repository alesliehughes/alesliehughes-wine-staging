From 23aa9f226cc8447ecf0a47a8d641d8ad70d02324 Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Tue, 23 Mar 2021 12:30:24 +1100
Subject: msado15: Implement _Recordset Find


diff --git a/dlls/msado15/recordset.c b/dlls/msado15/recordset.c
index aa2db6e2968..12426d1badc 100644
--- a/dlls/msado15/recordset.c
+++ b/dlls/msado15/recordset.c
@@ -1725,9 +1725,93 @@ static HRESULT WINAPI recordset_put_MarshalOptions( _Recordset *iface, MarshalOp
 static HRESULT WINAPI recordset_Find( _Recordset *iface, BSTR criteria, LONG skip_records,
                                       SearchDirectionEnum search_direction, VARIANT start )
 {
-    FIXME( "%p, %s, %ld, %d, %s\n", iface, debugstr_w(criteria), skip_records, search_direction,
+    struct recordset *recordset = impl_from_Recordset( iface );
+    HRESULT hr;
+    WCHAR column[256];
+    WCHAR value[256];
+    WCHAR *p, *c;
+
+    FIXME( "%p, %s, %ld, %d, %s\n", recordset, debugstr_w(criteria), skip_records, search_direction,
            debugstr_variant(&start) );
-    return E_NOTIMPL;
+
+    p = wcsstr(criteria, L"=");
+    if (p)
+    {
+        VARIANT index, rhs;
+        ULONG datacol = 0;
+        ULONG colcnt = get_column_count(recordset);
+        DataTypeEnum datatype;
+
+        c = p;
+        while (isspace(*c) || *c == '=') --c; /* strip trailing LWS */
+        lstrcpynW(column, criteria, c - criteria + 2);
+
+        FIXME("Column %s\n", debugstr_w(column));
+
+        V_VT(&index) = VT_BSTR;
+        V_BSTR(&index) = column;
+
+        if ((hr = map_index( recordset->fields, &index, &datacol )) != S_OK)
+        {
+            FIXME("No Column name");
+            return hr;
+        }
+
+        field_get_Type(recordset->fields->field[datacol], &datatype);
+        FIXME("Column index %ld, type %d\n", datacol, datatype);
+
+        if (datatype == adBSTR || datatype == adWChar)
+        {
+            int i = 0;
+
+            while (isspace(*p) || *p != '\'') p++;
+            p++; /* Skip ' */
+            while (*p != '\'')
+            {
+                value[i++] = *p;
+                p++;
+            }
+            value[i] = '\0';
+
+            V_VT(&rhs) = VT_BSTR;
+            V_BSTR(&rhs) = value;
+        }
+        else
+        {
+            long val;
+
+            p++; /* Skip = */
+            val = wcstol(p, NULL, 10);
+
+            V_VT(&rhs) = VT_I4;
+            V_I4(&rhs) = val;
+        }
+
+        FIXME("value %s\n", debugstr_variant(&rhs));
+
+        recordset->index += skip_records;
+        for(; recordset->index < recordset->count; recordset->index++)
+        {
+            FIXME("Data %s\n", debugstr_variant(&recordset->data[recordset->index * colcnt + datacol]));
+            if (datatype == adBSTR || datatype == adWChar)
+            {
+                if (lstrcmpW(V_BSTR(&recordset->data[recordset->index * colcnt + datacol]), V_BSTR(&rhs)) == 0)
+                    break;
+            }
+            else
+            {
+                if (V_I4(&recordset->data[recordset->index * colcnt + datacol]) == V_I4(&rhs))
+                    break;
+            }
+        }
+    }
+
+/*    if (search_direction == adSearchForward)
+        recordset->index = recordset->count;
+    else
+        recordset->index = -1;
+*/
+    return S_OK;
 }
 
 static HRESULT WINAPI recordset_Cancel( _Recordset *iface )
